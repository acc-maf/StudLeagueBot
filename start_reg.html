from config import settings
import telebot
from defs_meros import *
from telebot import types
import sqlite3
from json import loads
import requests

admins = ['7917683744', '737942168', '6070976396', '1396645155', '871296258', '1984219536', '1105133767']
technoadmins = []
darkturnadmins = []
letiadmins = []
bonchadmins = []
polytechadmins = []
miningadmins = []
eveningadmins = []

bot = telebot.TeleBot(settings['TOKEN'])
current_club = ''


@bot.message_handler(commands=['start'])
def start(message):
    markup = types.InlineKeyboardMarkup()
    base = sqlite3.connect('users')
    cur = base.cursor()
    cur.execute('SELECT id FROM users')
    users = cur.fetchall()
    cur.close()
    base.close()

    '''for i in users:
        if str(i[0]) == str(message.chat.id): # Зареган ли юзер? Да -> Кнопка меню и скип регистрации
            markup.add(types.InlineKeyboardButton('Меню', callback_data='menu'))
            bot.send_message(message.chat.id, "Привет!\n", reply_markup=markup)
            break
    else:'''
    markup.add(types.InlineKeyboardButton('Создать профиль', callback_data='start_reg'))
    bot.send_message(message.chat.id, "Привет!\n", reply_markup=markup)


def start_reg(message):
    markup = types.ReplyKeyboardMarkup()
    markup.add(types.KeyboardButton('Создать профиль', web_app=types.WebAppInfo(
        url='https://acc-maf.github.io/StudLeagueBot/start_reg.html')))
    bot.send_message(message.chat.id, "Нажмите кнопку для регистрации", reply_markup=markup)


def end_reg(message, data):
    base = sqlite3.connect('users')
    cur = base.cursor()
    cur.execute(f'DELETE FROM users WHERE id = {message.chat.id}')  # Удаление старого аккаунта пользователя
    base.commit()
    cur.execute(f'INSERT INTO users (id, nick, club) VALUES ("{message.chat.id}", "{data["nick"]}", "{data["club"]}")')
    base.commit()
    cur.close()
    base.close()
    bot.send_message(message.chat.id, "Вы успешно зарегистрировались! Также вы можете прикрепить свое фото для анонсов турниров, нажав кнопку ниже.", message_effect_id='5107584321108051014', reply_markup=types.ReplyKeyboardRemove())
    profileshow(message)


@bot.message_handler(commands=['menu'])
def menu(message):
    markup = types.InlineKeyboardMarkup(row_width=2)
    btn1 = types.InlineKeyboardButton('Игры в клубах', callback_data='clubs_list')
    btn2 = types.InlineKeyboardButton('Турниры', callback_data='tournaments_list')
    btn3 = types.InlineKeyboardButton('Профиль', callback_data='profile_show')
    btn4 = types.InlineKeyboardButton('Расписание', callback_data='schedule')
    btn5 = types.InlineKeyboardButton('Правила', url='https://t.me/mafiarulesteach_bot')
    btn6 = types.InlineKeyboardButton('Группа в VK', url='https://vk.com/studmafiaspb')
    btn7 = types.InlineKeyboardButton('Техподдержка', url='https://t.me/acc_maf')
    btn8 = types.InlineKeyboardButton('Задонатить организаторам', callback_data='donut')
    markup.add(btn1, btn2, btn3, btn4, btn5, btn6, btn7, btn8)
    bot.send_message(message.chat.id, "Выберите опцию:", reply_markup=markup)


@bot.callback_query_handler(func=lambda callback: True)
def callbacks(callback):
    base_tourn = sqlite3.connect('tournaments_list')
    cur_tourn = base_tourn.cursor()

    cur_tourn.execute('SELECT identify, num FROM tournaments')
    data = cur_tourn.fetchall()

    cur_tourn.close()
    base_tourn.close()

    if callback.data == 'menu': # Открыть меню
        menu(callback.message)
        return
    if callback.data == 'donut': # Выслать счет для доната
        donut1(callback.message)
        return
    if callback.data == 'schedule': # Выслать счет для доната
        schedule(callback.message)
        return
    if callback.data == 'profile_show': # Просмотр профиля (из меню)
        profileshow(callback.message)
        return
    if callback.data == 'profile_change': # Изменение профиля (из просмотра)
        profilechange1(callback.message)
        return
    if callback.data == 'start_reg': # Начало регистрации в боте
        start_reg(callback.message)
        return
    if callback.data == 'tournaments_list':  # Посмотреть список турниров
        tournaments_list(callback.message, 0)
        return
    if callback.data == 'ad_tournaments_list':  # Посмотреть список турниров
        tournaments_list(callback.message, 1)
        return
    if callback.data == 'clubs_list': # Посмотреть список клубов
        clubs_list(callback.message)
        return
    if callback.data == 'userslist': # посмотреть список зареганных юзеров в боте
        userslist(callback.message, 0)
        return
    if callback.data == 'userchange': # изменить юзера бота
        datachange1(callback.message)
        return
    if callback.data == 'create_tourn': # создать турнир
        tournament_create1(callback.message)
        return
    if callback.data == 'spam': # для рассылки пользователям бота
        spam1(callback.message)
        return

    for i in data: # i[0] - идентификатор турнира, i[1] - порядковый номер в таблице
        if callback.data == i[0]: # Для просмотра инфы о турнире
            tournament_info(callback.message, i[0], i[1], 0)
            return
        if callback.data == i[0] + 'ad': # Для админ просмотра инфы о турнире
            tournament_info(callback.message, i[0], i[1], 1)
            return
        if callback.data == i[0] + 'tourn_reg': # для регистрации на турнир
            registering(callback.message, i[0])
            return
        if callback.data == i[0] + 'members': # для просмотра участников турнира
            mero_members(callback.message, i[0], 1)
            return
        if callback.data == i[0] + 'cancel_reg': # для отмены регистрации на турнир
            cancel_reg(callback.message, i[0])
            return
        if callback.data == i[0] + 'edit': # изменить турнир
            tournament_edit1(callback.message, i[0])
            return
        if callback.data == i[0] + 'delete': # удалить турнир
            tournament_delete(callback.message, i[0])
            return
        if callback.data == i[0] + 'send': # рассылка участникам турнира
            send1(callback.message, i[0])
            return
        if callback.data == i[0] + 'confirm': # для подтверждения участия в меро
            confirm(callback.message, i[0])
            return
        if callback.data == i[0] + 'profiles': # просмотр профилей участников турнира
            profiles_view(callback.message, i[0])
            return
        if callback.data == i[0] + 'requests': # просмотр заявок на турнир
            check_requests(callback.message, i[0])
            return

    clubs = ['DarkTurn', 'LETI', 'Polytech', 'Mining', 'EveningParty', 'TechnoMafia', 'BONCHMAFIA']
    for i in clubs:
        base_clubs = sqlite3.connect('clubs')
        cur_clubs = base_clubs.cursor()
        cur_clubs.execute(f'SELECT identify, limits FROM {i}')
        data = cur_clubs.fetchall()
        cur_clubs.close()
        base_clubs.close()
        if callback.data == i + 'admin': # для админ-просмотра списка мероприятий клуба
            club_admin(callback.message, i)
            return
        if callback.data == i + 'create': # для админ-создания мероприятия клуба
            mero_create1(callback.message, i)
            return
        for j in data: # j[0] - идентификатор мероприятия
            if callback.data == i + j[0] + 'reg': # для регистрации на мероприятие клуба
                registering(callback.message, j[0], club=i)
                return
            if callback.data == i + j[0] + 'members': # для просмотра участников мероприятия
                mero_members(callback.message, j[0], 1, club=i)
                return
            if callback.data == i + j[0] + 'cancel_reg': # для отмены регистрации на мероприятие
                cancel_reg(callback.message, j[0], club=i)
                return
            if callback.data == i + j[0] + 'info': # для просмотра инфы о мероприятии
                clubs_evening_info(callback.message, j[0], i, 0)
                return
            if callback.data == i + j[0] + 'admininfo': # для админ-просмотра инфы о мероприятии
                clubs_evening_info(callback.message, j[0], i, 1)
                return
            if callback.data == i + j[0] + 'edit': # для изменения инфы о мероприятии
                mero_edit1(callback.message, j[0], i)
                return
            if callback.data == i + j[0] + 'delete': # для удаления мероприятия
                mero_delete(callback.message, j[0], i)
                return
            if callback.data == i + j[0] + 'send': # для рассылки участникам мероприятия
                send1(callback.message, j[0], i)
                return
            if callback.data == i + j[0] + 'confirm': # для подтверждения участия в меро
                confirm(callback.message, j[0], i)
                return
            if callback.data == i + j[0] + 'profiles': # для просмотра профилей участников мероприятия
                profiles_view(callback.message, j[0], i)
                return
            if callback.data == i + j[0] + 'requests': # для просмотра заявок на мероприятия
                check_requests(callback.message, j[0], i)
                return

    for i in data:
        base = sqlite3.connect('tournament')
        cur = base.cursor()
        try:
            cur.execute(f'SELECT id FROM {i[0]}')
        except:
            bot.send_message(callback.message.chat.id, "Что-то пошло не так!")
            cur.close()
            base.close()
            return
        members = cur.fetchall()
        cur.close()
        base.close()
        for k in members:  # k[0] - айди участника подавшего заявку на меро
            if callback.data == k[0] + i[0] + 'accept':
                accept_request(callback.message, i[0], k[0])
                return
            if callback.data == k[0] + i[0] + 'decline':
                decline_request(callback.message, i[0], k[0])
                return

    for i in clubs:
        for j in data:  # j[0] - идентификатор мероприятия
            base = sqlite3.connect('mero')
            cur = base.cursor()
            try:
                cur.execute(f'SELECT id FROM {j[0]}')
            except:
                bot.send_message(callback.message.chat.id, "Что-то пошло не так!")
                cur.close()
                base.close()
                return
            members = cur.fetchall()
            base.close()
            cur.close()
            for k in members: # k[0] - айди участника подавшего заявку на меро
                if callback.data == k[0] + i + j[0] + 'accept':
                    accept_request(callback.message, j[0], k[0], i)
                    return
                if callback.data == k[0] + i + j[0] + 'decline':
                    decline_request(callback.message, j[0], k[0], i)
                    return


@bot.message_handler(content_types=['web_app_data'])
def web_app(message):
    data = loads(message.web_app_data.data)
    if message.web_app_data.button_text == 'Зарегистрироваться':
        teamreg2(message, data)
        return
    if message.web_app_data.button_text == 'Создать профиль':
        end_reg(message, data)
        return

    dicti = "abcdefghijklmnopqrstuvwxyz0123456789_-"
    if not all(data["identify"].lower().count(i) <= dicti.count(i) for i in data["identify"].lower()):
        bot.send_message(message.chat.id,
                         "Неверный идентификатор! Используйте только английские буквы, цифры, _ и -",
                         reply_markup=types.ReplyKeyboardRemove())
        return

    if message.web_app_data.button_text == 'Создать турнир':
        tournament_create2(message, data)
        return
    if message.web_app_data.button_text == 'Создать мероприятие':
        mero_create2(message, data)
        return


def clubs_list(message):
    markup = types.ReplyKeyboardMarkup()
    btn1 = types.KeyboardButton('TechnoMafia')
    btn2 = types.KeyboardButton('Чёрный ход')
    btn3 = types.KeyboardButton('LETI-MAFIA')
    btn4 = types.KeyboardButton('BONCHMAFIA')
    btn5 = types.KeyboardButton('Polytech mafia community')
    btn6 = types.KeyboardButton('Mining Mafia')
    btn7 = types.KeyboardButton('Вечерняя партия')
    markup.row(btn1, btn2, btn3)
    markup.row(btn4, btn5, btn6, btn7)
    bot.send_message(message.chat.id, "Выберите клуб: ", reply_markup=markup)
    bot.register_next_step_handler(message, club_evening)


def club_evening(message):
    bot.send_message(message.chat.id, '.', reply_markup=types.ReplyKeyboardRemove())  # сообщение для удаления плиток
    try:
        bot.delete_message(message.chat.id, message.message_id+1)
    except Exception as e:
        print(e)
    if message.text == 'Чёрный ход':
        club = 'DarkTurn'
    elif message.text == 'LETI-MAFIA':
        club = 'LETI'
    elif message.text == 'Polytech mafia community':
        club = 'Polytech'
    elif message.text == 'Mining Mafia':
        club = 'Mining'
    elif message.text == 'Вечерняя партия':
        club = 'EveningParty'
    elif message.text == 'TechnoMafia':
        club = 'TechnoMafia'
    elif message.text == 'BONCHMAFIA':
        club = 'BONCHMAFIA'
    else:
        bot.send_message(message.chat.id, 'Клуб не найден!')
        menu(message)
        return

    base = sqlite3.connect('clubs')
    cur = base.cursor()

    cur.execute(f'SELECT * FROM {club}')
    data = cur.fetchall()

    cur.close()
    base.close()

    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton('Вернуться в меню', callback_data='menu'))
    for i in data:
        if int(i[6]) == 1: # если статус = 1, то есть его могут увидеть участники
            markup.add(types.InlineKeyboardButton(i[2], callback_data=club + i[1] + 'info'))
    bot.send_message(message.chat.id, 'Выберите мероприятие: ', reply_markup=markup)


def clubs_evening_info(message, identify, club, typ):  # typ = 1 - команда вызвана админом, = 0 - обычным пользователем
    base = sqlite3.connect('clubs')
    cur = base.cursor()

    base_mero = sqlite3.connect('mero')
    cur_mero = base_mero.cursor()

    try:
        cur_mero.execute(f'SELECT * FROM {club+identify}')
        players = cur_mero.fetchall()
    except:
        players = []

    cur_mero.close()
    base_mero.close()

    cnt = 0
    for i in players:
        cnt += 1

    try:
        cur.execute(f'SELECT * FROM {club} WHERE identify = ?', (identify, ))
    except:
        bot.send_message(message, 'Мероприятие не найдено')
        menu(message)
        return
    else:
        data = cur.fetchall()
        cur.close()
        base.close()

    markup = types.InlineKeyboardMarkup()
    for i in data:
        if typ:
            if i[6] == 2:
                markup.add(types.InlineKeyboardButton('Посмотреть заявки', callback_data=club + i[1] + 'requests'))
            markup.add(types.InlineKeyboardButton('Изменить', callback_data=club + i[1] + 'edit'))
            markup.add(types.InlineKeyboardButton('Удалить', callback_data=club + i[1] + 'delete'))
            markup.add(types.InlineKeyboardButton('Рассылка', callback_data=club + i[1] + 'send'))
            markup.add(types.InlineKeyboardButton('Посмореть профили', callback_data=club + i[1] + 'profiles'))
        else:
            markup.add(types.InlineKeyboardButton('Вернуться в меню', callback_data='menu'))
            if i[6] == 1:
                markup.add(types.InlineKeyboardButton('Регистрация', callback_data=club + i[1] + 'reg'))
            else:
                markup.add(types.InlineKeyboardButton('Отправить заявку', callback_data=club + i[1] + 'reg'))
            markup.add(types.InlineKeyboardButton('Список участников', callback_data=club + i[1] + 'members'))
        bot.send_message(message.chat.id, info(i[2], i[3], i[4], i[5], i[6], members=cnt, cost=i[7]), reply_markup=markup)
        break


def profileshow(message):
    base = sqlite3.connect('users')
    cur = base.cursor()

    cur.execute('SELECT * FROM users')
    data = cur.fetchall()

    cur.close()
    base.close()

    for i in data:
        if i[1] == str(message.chat.id):
            save_path = f'pp\\{message.chat.id}.png'
            try:
                with open(save_path, 'rb') as file:
                    bot.send_photo(i[1], file)
            except:
                pass
            markup = types.InlineKeyboardMarkup()
            markup.add(types.InlineKeyboardButton('Вернуться в меню', callback_data='menu'))
            markup.add(types.InlineKeyboardButton('Изменить профиль', callback_data='profile_change'))
            bot.send_message(message.chat.id, 'Ваш профиль:\n\nНик: ' + i[2] + '\nКлуб: ' + i[3], reply_markup=markup)
            break
    else:
        markup = types.InlineKeyboardMarkup()
        markup.row(types.InlineKeyboardButton('Зарегистрироваться в боте', callback_data='start_reg'))
        bot.send_message(message.chat.id, f"Ошибка: вы не зарегистрированы в боте!", reply_markup=markup)


def profilechange1(message):
    markup = types.ReplyKeyboardMarkup()
    markup.add(types.KeyboardButton('Ник'), types.KeyboardButton('Клуб'), types.KeyboardButton('Картинку'))
    bot.send_message(message.chat.id, "Что вы хотите изменить?", reply_markup=markup)
    bot.register_next_step_handler(message, profilechange2)


def profilechange2(message):
    if message.text == 'Ник':
        bot.send_message(message.chat.id, "Введите новый ник", reply_markup=types.ReplyKeyboardRemove())
        bot.register_next_step_handler(message, profilechange3)
        return
    if message.text == 'Клуб':
        markup = types.ReplyKeyboardMarkup()
        btn1 = types.KeyboardButton('TechnoMafia')
        btn2 = types.KeyboardButton('Чёрный ход')
        btn3 = types.KeyboardButton('LETI-MAFIA')
        btn4 = types.KeyboardButton('BONCHMAFIA')
        btn5 = types.KeyboardButton('Polytech mafia community')
        btn6 = types.KeyboardButton('Mining Mafia')
        btn7 = types.KeyboardButton('Вечерняя партия')
        btn8 = types.KeyboardButton('Polemica SPb')
        btn9 = types.KeyboardButton('Иллюzия ОбмаNа')
        btn10 = types.KeyboardButton('TITAN SPb')
        markup.row(btn1, btn2, btn3, btn4)
        markup.row(btn5, btn6, btn7)
        markup.row(btn8, btn9, btn10)
        bot.send_message(message.chat.id, "Выберите клуб или введите его название, если вашего нет в списке", reply_markup=markup)
        bot.register_next_step_handler(message, profilechange4)
        return
    if message.text == 'Картинку':
        bot.send_message(message.chat.id, "Отправьте ваше фото, которое будет использоваться для анонсов турниров и мероприятий", reply_markup=types.ReplyKeyboardRemove())
        bot.register_next_step_handler(message, profilechange5)
        return


def profilechange3(message):
    base = sqlite3.connect('users')
    cur = base.cursor()
    cur.execute('UPDATE users SET nick = ? WHERE id = ?', (message.text, message.chat.id))
    base.commit()
    cur.close()
    base.close()

    bot.send_message(message.chat.id, "Успешно")
    menu(message)


def profilechange4(message):
    base = sqlite3.connect('users')
    cur = base.cursor()
    cur.execute('UPDATE users SET club = ? WHERE id = ?', (message.text, message.chat.id))
    base.commit()
    cur.close()
    base.close()

    bot.send_message(message.chat.id, "Успешно", reply_markup=types.ReplyKeyboardRemove())
    menu(message)


def profilechange5(message):
    if message.content_type != 'photo':
        bot.send_message(message.chat.id, "Вы отправили не фото!")
        menu(message)
        return
    image = bot.download_file(bot.get_file(message.photo[-1].file_id).file_path)
    save_path = f'pp\\{message.chat.id}.png'
    with open(save_path, 'wb+') as file:
        file.write(image)

    bot.send_message(message.chat.id, "Успешно!")
    menu(message)


@bot.pre_checkout_query_handler(func=lambda callback: True)
def pre_checkout_query(pre_check):
    bot.answer_pre_checkout_query(pre_check.id, True)


@bot.message_handler(content_types=['successful_payment'])
def success(message):
    payload = message.successful_payment.invoice_payload
    if payload == 'donut':
        bot.send_message(message.chat.id, "Большое спасибо за поддержку студлиги!!!")
        bot.send_message(-4691783391, f"{message.from_user.first_name} {message.from_user.last_name} поддержал нас на {int(message.successful_payment.total_amount/100)} рублей!!")
        return
    base_tourn = sqlite3.connect('tournaments_list')
    cur_tourn = base_tourn.cursor()

    base_clubs = sqlite3.connect('clubs')
    cur_clubs = base_clubs.cursor()

    cur_tourn.execute('SELECT identify FROM tournaments')
    data = cur_tourn.fetchall()


    for i in data:  # i[0] - идентификатор турнира
        if payload == i[0]:
            base_mero = sqlite3.connect('tournament')
            cur_mero = base_mero.cursor()
            cur_mero.execute(f'UPDATE {i[0]} SET paid = ? WHERE id = ?', (1, message.chat.id))
            base_mero.commit()
            cur_clubs.close()
            base_clubs.close()
            cur_tourn.close()
            base_tourn.close()
            cur_mero.close()
            base_mero.close()
            bot.send_message(message.chat.id, "Взнос успешно оплачен")
            return

    clubs = ['DarkTurn', 'LETI', 'Polytech', 'Mining', 'EveningParty', 'TechnoMafia', 'BONCHMAFIA']
    for i in clubs:
        cur_clubs.execute(f'SELECT identify FROM {i}')
        data = cur_clubs.fetchall()
        for j in data:  # j[0] - идентификатор мероприятия
            if payload == i + j[0]:
                base_mero = sqlite3.connect('mero')
                cur_mero = base_mero.cursor()
                cur_mero.execute(f'UPDATE {i + j[0]} SET paid = ? WHERE id = ?', (1, message.chat.id))
                base_mero.commit()
                cur_clubs.close()
                base_clubs.close()
                cur_tourn.close()
                base_tourn.close()
                cur_mero.close()
                base_mero.close()
                bot.send_message(message.chat.id, "Взнос успешно оплачен")
                return


@bot.message_handler(commands=['admin'])
def admin(message):
    global admins, letiadmins, bonchadmins, miningadmins, technoadmins, darkturnadmins, eveningadmins, polytechadmins
    markup = types.InlineKeyboardMarkup(row_width=4)
    for i in admins:
        if str(message.chat.id) == i:
            markup.add(types.InlineKeyboardButton('Турнир', callback_data='ad_tournaments_list'))
            markup.add(types.InlineKeyboardButton('Пользователи бота', callback_data='userslist'))
            markup.add(types.InlineKeyboardButton('Рассылка', callback_data='spam'))
            markup.add(types.InlineKeyboardButton('TechnoMafia', callback_data='TechnoMafia' + 'admin'))
            markup.add(types.InlineKeyboardButton('Чёрный ход', callback_data='DarkTurn' + 'admin'))
            markup.add(types.InlineKeyboardButton('LETI-MAFIA', callback_data='LETI' + 'admin'))
            markup.add(types.InlineKeyboardButton('BONCHMAFIA', callback_data='BONCHMAFIA' + 'admin'))
            markup.add(types.InlineKeyboardButton('Polytech mafia community', callback_data='Polytech' + 'admin'))
            markup.add(types.InlineKeyboardButton('Mining Mafia', callback_data='Mining' + 'admin'))
            markup.add(types.InlineKeyboardButton('Вечерняя партия', callback_data='EveningParty' + 'admin'))
            break
    else:
        for i in technoadmins:
            if str(message.chat.id) == i:
                markup.add(types.InlineKeyboardButton('TechnoMafia', callback_data='TechnoMafia' + 'admin'))
                break
        else:
            for i in darkturnadmins:
                if str(message.chat.id) == i:
                    markup.add(types.InlineKeyboardButton('Чёрный ход', callback_data='DarkTurn' + 'admin'))
                    break
            else:
                for i in letiadmins:
                    if str(message.chat.id) == i:
                        markup.add(types.InlineKeyboardButton('LETI-MAFIA', callback_data='LETI' + 'admin'))
                        break
                else:
                    for i in bonchadmins:
                        if str(message.chat.id) == i:
                            markup.add(types.InlineKeyboardButton('BONCHMAFIA', callback_data='BONCHMAFIA' + 'admin'))
                            break
                    else:
                        for i in polytechadmins:
                            if str(message.chat.id) == i:
                                markup.add(types.InlineKeyboardButton('Polytech mafia community', callback_data='Polytech' + 'admin'))
                                break
                        else:
                            for i in miningadmins:
                                if str(message.chat.id) == i:
                                    markup.add(types.InlineKeyboardButton('Mining Mafia', callback_data='Mining' + 'admin'))
                                    break
                            else:
                                for i in eveningadmins:
                                    if str(message.chat.id) == i:
                                        markup.add(types.InlineKeyboardButton('Вечерняя партия', callback_data='EveningParty' + 'admin'))
                                        break
                                else:
                                    bot.send_message(message.chat.id, f"Ты не админ.")
                                    return

    bot.send_message(message.chat.id, 'Вы админ:', reply_markup=markup)


def club_admin(message, club):
    base = sqlite3.connect('clubs')
    cur = base.cursor()

    cur.execute(f'SELECT name, identify FROM {club}')
    data = cur.fetchall()

    cur.close()
    base.close()

    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton('Создать мероприятие', callback_data=club + 'create'))
    for i in data:
        markup.add(types.InlineKeyboardButton(i[0], callback_data=club + i[1] + 'admininfo'))
    bot.send_message(message.chat.id, 'Выберите мероприятие: ', reply_markup=markup)


def userslist(message, typ):
    base = sqlite3.connect('users')
    cur = base.cursor()

    cur.execute('SELECT * FROM users')
    players = cur.fetchall()

    players_output = ''
    for i in players:
        players_output += f'№{i[0]}. {i[1]} - {i[2]} - {i[3]}\n'

    markup = types.InlineKeyboardMarkup()
    if typ:
        markup.add(types.InlineKeyboardButton('Изменить', callback_data='userchange'))

    bot.send_message(message.chat.id, players_output, reply_markup=markup)

    cur.close()
    base.close()


def datachange1(message):
    for i in admins:
        if str(message.chat.id) == i:
            userslist(message, 1)
            bot.send_message(message.chat.id, f"Введите номер пользователя, данные которого хотите изменить")
            bot.register_next_step_handler(message, datachange2)
            break
    else:
        bot.send_message(message.chat.id, f"Ты не админ.")


def datachange2(message):
    base = sqlite3.connect('users')
    cur = base.cursor()

    cur.execute('SELECT * FROM users')
    players = cur.fetchall()

    cur.close()
    base.close()

    until = 0
    try:
        until = int(message.text)
    except:
        bot.send_message(message.chat.id, "Введите только число!")
        bot.register_next_step_handler(message, datachange1)

    cnt = 0
    for i in players:
        cnt += 1
        if cnt == until:
            markup = types.ReplyKeyboardMarkup()
            markup.add(types.KeyboardButton('Ник'), types.KeyboardButton('Клуб'))
            bot.send_message(message.chat.id, "Что вы хотите изменить?", reply_markup=markup)
            bot.register_next_step_handler(message, datachange3, i)
            break
    else:
        bot.send_message(message.chat.id, "Пользователь с таким номером не зарегистрирован")
        return


def datachange3(message, i):
    if message.text == 'Ник':
        bot.send_message(message.chat.id, "Введите новый ник", reply_markup=types.ReplyKeyboardRemove())
        bot.register_next_step_handler(message, datachange4, i)
    if message.text == 'Клуб':
        markup = types.ReplyKeyboardMarkup()
        btn1 = types.KeyboardButton('TechnoMafia')
        btn2 = types.KeyboardButton('Чёрный ход')
        btn3 = types.KeyboardButton('LETI-MAFIA')
        btn4 = types.KeyboardButton('BONCHMAFIA')
        btn5 = types.KeyboardButton('Polytech mafia community')
        btn6 = types.KeyboardButton('Mining Mafia')
        btn7 = types.KeyboardButton('Вечерняя партия')
        btn8 = types.KeyboardButton('Polemica SPb')
        btn9 = types.KeyboardButton('Иллюzия ОбмаNа')
        btn10 = types.KeyboardButton('TITAN SPb')
        markup.row(btn1, btn2, btn3, btn4)
        markup.row(btn5, btn6, btn7)
        markup.row(btn8, btn9, btn10)
        bot.send_message(message.chat.id, "Введите новый клуб", reply_markup=markup)
        bot.register_next_step_handler(message, datachange5, i)
    else:
        bot.send_message(message.chat.id, '.',
                         reply_markup=types.ReplyKeyboardRemove())  # сообщение для удаления плиток
        try:
            bot.delete_message(message.chat.id, message.message_id + 1)
        except Exception as e:
            print(e)
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton('Вернуться в меню', callback_data='menu'))
        bot.send_message(message.chat.id, "Не понял, воспользуйтесь кнопками!", reply_markup=markup)


def datachange4(message, i):
    base = sqlite3.connect('users')
    cur = base.cursor()

    cur.execute('UPDATE users SET nick = ? WHERE num = ?', (message.text, i[0]))
    base.commit()
    bot.send_message(message.chat.id, "Успешно")
    cur.close()
    base.close()

    userslist(message, 1)


def datachange5(message, i):
    base = sqlite3.connect('users')
    cur = base.cursor()

    cur.execute('UPDATE users SET club = ? WHERE num = ?', (message.text, i[0]))
    base.commit()
    bot.send_message(message.chat.id, "Успешно", reply_markup=types.ReplyKeyboardRemove())
    cur.close()
    base.close()

    userslist(message, 1)


def profiles_view(message, identify, club=None):
    try:
        if club:
            base = sqlite3.connect('mero')
            cur = base.cursor()
            cur.execute(f'SELECT * FROM {club + identify}')
        else:
            base = sqlite3.connect('tournament')
            cur = base.cursor()
            cur.execute(f'SELECT * FROM {identify}')
        players = cur.fetchall()
        cur.close()
        base.close()
    except:
        bot.send_message(message.chat.id, "Участников нет!")
        return

    for i in players:
        try:
            save_path = f'pp\\{i[1]}.png'  # f'pp/{message.chat.id}.png'
            with open(save_path, 'rb') as file:
                bot.send_photo(message.chat.id, file)
        except:
            pass
        bot.send_message(message.chat.id, 'Ник: ' + i[2] + '\nКлуб: ' + i[3])


def tournament_create1(message):
    base = sqlite3.connect('tournaments_list')
    cur = base.cursor()
    cur.execute('SELECT identify FROM tournaments')
    data = cur.fetchall()
    cur.close()
    base.close()

    cnt = 0
    output = ''
    bot.send_message(message.chat.id, 'При создании понадобится ввести идентификатор мероприятия. Он должен содержать только английские буквы, цифры, -_, без пробелов. Необходимо, чтобы он был уникальным и соответствовал названию турнира.\nПримеры: my_first_tourn1, StudLeague3\n\nЗанятые индетефикаторы:.')
    for i in data:
        cnt += 1
        output += str(cnt) + '. ' + i[0] + '\n'
    if output != '':
        bot.send_message(message.chat.id, output)
    markup = types.ReplyKeyboardMarkup()
    markup.add(types.KeyboardButton('Создать турнир', web_app=types.WebAppInfo(
        url='https://acc-maf.github.io/StudLeagueBot/tournament_create.html')))
    bot.send_message(message.chat.id, 'Нажмите на кнопку для создания турнира', reply_markup=markup)


def tournament_create2(message, data):
    base = sqlite3.connect('tournaments_list')
    cur = base.cursor()

    cur.execute('SELECT identify FROM tournaments')
    ids = cur.fetchall()
    for i in ids:
        if data["identify"] == i[0]:
            bot.send_message(message.chat.id, 'Такой идентификатор уже занят!', reply_markup=types.ReplyKeyboardRemove())
            cur.close()
            base.close()
            return

    try:
        cur.execute(
            f'INSERT INTO tournaments (identify, name, desc, date, rules, score, type, limits, status, cost) VALUES ("{data["identify"]}", "{data["name"]}", "{data["desc"]}", "{data["date"]}", "{data["rules"]}", "{data["score"]}", "{data["typ"]}", "{int(data["limit"])}", 0, "{int(data["cost"])}")')
    except:
        cur.close()
        base.close()
        bot.send_message(message.chat.id, "Произошла ошибка (скорее всего, вы не заполнили какое-то поле)", reply_markup=types.ReplyKeyboardRemove())
    base.commit()
    cur.close()
    base.close()

    bot.send_message(message.chat.id, "Успешный успех", message_effect_id='5107584321108051014', reply_markup=types.ReplyKeyboardRemove())
    bot.send_message(message.chat.id,
                 info(data["name"], data["desc"], data["date"], rules=data["rules"], score=data["score"],
                      typ=data["typ"], limit=int(data["limit"]), status=0, cost=data["cost"]))


def mero_create1(message, club):
    global current_club
    current_club = club
    base = sqlite3.connect('clubs')
    cur = base.cursor()
    cur.execute(f'SELECT identify FROM {club}')
    data = cur.fetchall()
    cur.close()
    base.close()
    cnt = 0
    output = ''
    bot.send_message(message.chat.id, 'При создании понадобится ввести идентификатор мероприятия. Он должен содержать только английские буквы, цифры, -_, без пробелов. Необходимо, чтобы он был уникальным и соответствовал названию турнира.\nПримеры: techno_evening1, bonchevening8\n\nЗанятые индетефикаторы:.')
    for i in data:
        cnt += 1
        output += str(cnt) + '. ' + i[0] + '\n'
    if output != '':
        bot.send_message(message.chat.id, output)
    markup = types.ReplyKeyboardMarkup()
    markup.add(types.KeyboardButton('Создать мероприятие', web_app=types.WebAppInfo(
        url='https://acc-maf.github.io/StudLeagueBot/mero_create.html')))
    bot.send_message(message.chat.id, 'Нажмите на кнопку для создания мероприятия', reply_markup=markup)


def mero_create2(message, data):
    global current_club
    base = sqlite3.connect('clubs')
    cur = base.cursor()

    try:
        cur.execute(f'SELECT identify FROM {current_club}')
    except:
        cur.close()
        base.close()
        bot.send_message(message.chat.id, "Произошла ошибка (скорее всего, вы не заполнили какое-то поле)", reply_markup=types.ReplyKeyboardRemove())

    ids = cur.fetchall()
    for i in ids:
        if data["identify"] == i[0]:
            bot.send_message(message.chat.id, 'Такой идентификатор уже занят!',
                             reply_markup=types.ReplyKeyboardRemove())
            cur.close()
            base.close()
            return

    cur.execute(
        f'INSERT INTO {current_club} (identify, name, desc, date, limits, status, cost) VALUES ("{data["identify"]}", "{data["name"]}", "{data["desc"]}", "{data["date"]}", "{int(data["limit"])}", 0, "{int(data["cost"])}")')
    base.commit()
    cur.close()
    base.close()

    bot.send_message(message.chat.id, "Успешный успех", message_effect_id='5107584321108051014',
                     reply_markup=types.ReplyKeyboardRemove())
    bot.send_message(message.chat.id,
                     info(data["name"], data["desc"], data["date"], int(data["limit"]), 0, cost=data["cost"]))



def tournament_edit1(message, identify):
    base = sqlite3.connect('tournaments_list')
    cur = base.cursor()

    cur.execute('SELECT * FROM tournaments')
    data = cur.fetchall()

    cur.close()
    base.close()

    for i in data:
        if i[1] == identify:
            name = i[2]
            desc = i[3]
            date = i[4]
            rules = i[5]
            score = i[6]
            typ = i[7]
            limit = i[8]
            status = i[9]
            cost = i[10]
            bot.send_message(message.chat.id, info(name, desc, date, rules=rules, score=score, typ=typ, limit=limit, status=status, cost=cost))
            break

    markup = types.ReplyKeyboardMarkup()
    btn1= types.KeyboardButton('Статус')
    btn2 = types.KeyboardButton('Название')
    btn3 = types.KeyboardButton('Описание')
    btn4 = types.KeyboardButton('Дату')
    btn5 = types.KeyboardButton('Правила')
    btn6 = types.KeyboardButton('Скоринг')
    #btn7 = types.KeyboardButton('Тип')
    btn8 = types.KeyboardButton('Лимит')
    btn9 = types.KeyboardButton('Стоимость')
    btn10 = types.KeyboardButton('Добавить участников')
    btn11 = types.KeyboardButton('Удалить участников')
    markup.row(btn1, btn2, btn3)
    markup.row(btn4, btn5, btn6)
    markup.row(btn8, btn9)
    markup.row(btn10, btn11)
    bot.send_message(message.chat.id, 'Что вы хотите изменить?', reply_markup=markup)
    bot.register_next_step_handler(message, edit3, identify)


def mero_edit1(message, identify, club):
    base = sqlite3.connect('clubs')
    cur = base.cursor()

    cur.execute(f'SELECT * FROM {club}')
    data = cur.fetchall()

    cur.close()
    base.close()

    for i in data:
        if i[1] == identify:
            name = i[2]
            desc = i[3]
            date = i[4]
            limit = i[5]
            status = i[6]
            cost = i[7]
            bot.send_message(message.chat.id, info(name, desc, date, limit=limit, status=status, cost=cost))
            break

    markup = types.ReplyKeyboardMarkup()
    btn1 = types.KeyboardButton('Статус')
    btn2 = types.KeyboardButton('Название')
    btn3 = types.KeyboardButton('Описание')
    btn4 = types.KeyboardButton('Дату')
    btn5 = types.KeyboardButton('Лимит')
    btn6 = types.KeyboardButton('Стоимость')
    btn7 = types.KeyboardButton('Добавить участников')
    btn8 = types.KeyboardButton('Удалить участников')
    markup.row(btn1, btn2, btn3, btn4)
    markup.row(btn5, btn6, btn7, btn8)
    bot.send_message(message.chat.id, 'Что вы хотите изменить?', reply_markup=markup)
    bot.register_next_step_handler(message, edit3, identify, club)


def edit3(message, identify, club=None):
    if message.text == 'Название':
        edit4(message, identify, club)
    elif message.text == 'Описание':
        edit5(message, identify, club)
    elif message.text == 'Дату':
        edit6(message, identify, club)
    elif message.text == 'Правила':
        tournament_edit7(message, identify)
    elif message.text == 'Скоринг':
        tournament_edit8(message, identify)
    #elif message.text == 'Тип':
        #tournament_edit9(message, identify)
    elif message.text == 'Лимит':
        edit10(message, identify, club)
    elif message.text == 'Статус':
        edit11(message, identify, club)
    elif message.text == 'Стоимость':
        edit12(message, identify, club)
    elif message.text == 'Добавить участников':
        edit13(message, identify, club)
    elif message.text == 'Удалить участников':
        edit14(message, identify, club)
    else:
        bot.send_message(message.chat.id, 'Не пон')


def edit4(message, identify, club=None):
    bot.send_message(message.chat.id, "Введите новое название", reply_markup=types.ReplyKeyboardRemove())
    bot.register_next_step_handler(message, edit4_1, identify, club)


def edit4_1(message, identify, club=None):
    if club:
        base = sqlite3.connect('clubs')
        cur = base.cursor()

        cur.execute(f'UPDATE {club} SET name = ? WHERE identify = ?', (message.text, identify))
        base.commit()
    else:
        base = sqlite3.connect('tournaments_list')
        cur = base.cursor()

        cur.execute('UPDATE tournaments SET name = ? WHERE identify = ?', (message.text, identify))
        base.commit()

    bot.send_message(message.chat.id, "Успешно")
    cur.close()
    base.close()


def edit5(message, identify, club=None):
    bot.send_message(message.chat.id, "Введите новое описание турнира", reply_markup=types.ReplyKeyboardRemove())
    bot.register_next_step_handler(message, edit5_1, identify, club)


def edit5_1(message, identify, club=None):
    if club:
        base = sqlite3.connect('clubs')
        cur = base.cursor()

        cur.execute(f'UPDATE {club} SET desc = ? WHERE identify = ?', (message.text, identify))
        base.commit()
    else:
        base = sqlite3.connect('tournaments_list')
        cur = base.cursor()

        cur.execute('UPDATE tournaments SET desc = ? WHERE identify = ?', (message.text, identify))
        base.commit()

    bot.send_message(message.chat.id, "Успешно")
    cur.close()
    base.close()


def edit6(message, identify, club=None):
    bot.send_message(message.chat.id, "Введите новую дату турнира", reply_markup=types.ReplyKeyboardRemove())
    bot.register_next_step_handler(message, edit6_1, identify, club)


def edit6_1(message, identify, club=None):
    if club:
        base = sqlite3.connect('clubs')
        cur = base.cursor()

        cur.execute(f'UPDATE {club} SET date = ? WHERE identify = ?', (message.text, identify))
        base.commit()
    else:
        base = sqlite3.connect('tournaments_list')
        cur = base.cursor()

        cur.execute('UPDATE tournaments SET date = ? WHERE identify = ?', (message.text, identify))
        base.commit()

    bot.send_message(message.chat.id, "Успешно")
    cur.close()
    base.close()


def tournament_edit7(message, identify):
    bot.send_message(message.chat.id, "Введите новые правила турнира", reply_markup=types.ReplyKeyboardRemove())
    bot.register_next_step_handler(message, tournament_edit7_1, identify)


def tournament_edit7_1(message, identify):
    base = sqlite3.connect('tournaments_list')
    cur = base.cursor()

    cur.execute('UPDATE tournaments SET rules = ? WHERE identify = ?', (message.text, identify))
    base.commit()
    bot.send_message(message.chat.id, "Успешно")
    cur.close()
    base.close()


def tournament_edit8(message, identify):
    bot.send_message(message.chat.id, "Введите новый скоринг турнира", reply_markup=types.ReplyKeyboardRemove())
    bot.register_next_step_handler(message, tournament_edit8_1, identify)


def tournament_edit8_1(message, identify):
    base = sqlite3.connect('tournaments_list')
    cur = base.cursor()

    cur.execute('UPDATE tournaments SET score = ? WHERE identify = ?', (message.text, identify))
    base.commit()
    bot.send_message(message.chat.id, "Успешно")
    cur.close()
    base.close()


def tournament_edit9(message, identify):
    bot.send_message(message.chat.id, "Введите новый тип турнира", reply_markup=types.ReplyKeyboardRemove())
    bot.register_next_step_handler(message, tournament_edit9_1, identify)


def tournament_edit9_1(message, identify):
    base = sqlite3.connect('tournaments_list')
    cur = base.cursor()

    cur.execute('UPDATE tournaments SET type = ? WHERE identify = ?', (message.text, identify))
    base.commit()
    bot.send_message(message.chat.id, "Успешно")
    cur.close()
    base.close()


def edit10(message, identify, club=None):
    bot.send_message(message.chat.id, "Введите новый лимит участников турнира(ЦЕЛОЕ ЧИСЛО!!!)", reply_markup=types.ReplyKeyboardRemove())
    bot.register_next_step_handler(message, edit10_1, identify, club)


def edit10_1(message, identify, club=None):
    if club:
        base = sqlite3.connect('clubs')
        cur = base.cursor()

        cur.execute(f'UPDATE {club} SET limits = ? WHERE identify = ?', (message.text, identify))
        base.commit()
    else:
        base = sqlite3.connect('tournaments_list')
        cur = base.cursor()

        cur.execute('UPDATE tournaments SET limits = ? WHERE identify = ?', (message.text, identify))
        base.commit()

    bot.send_message(message.chat.id, "Успешно")
    cur.close()
    base.close()


def edit11(message, identify, club=None):
    markup = types.ReplyKeyboardMarkup()
    btn1 = types.KeyboardButton('Открытый')
    btn2 = types.KeyboardButton('Закрытый')
    btn3 = types.KeyboardButton('По заявке')
    markup.row(btn1, btn2, btn3)
    bot.send_message(message.chat.id, "Выберите новый статус.\nОткрытый - виден для всех, каждый может зарегистрироваться.\nЗакрытый - виден только для админов\nПо заявке - каждый может подать заявку, которая придет создателю турнира", reply_markup=markup)
    bot.register_next_step_handler(message, edit11_1, identify, club)


def edit11_1(message, identify, club=None):
    if club:
        base = sqlite3.connect('clubs')
        cur = base.cursor()

        if message.text == 'Открытый':
            cur.execute(f'UPDATE {club} SET status = ? WHERE identify = ?', (1, identify))
            base.commit()
            bot.send_message(message.chat.id, "Успешно", reply_markup=types.ReplyKeyboardRemove())
        elif message.text == 'Закрытый':
            cur.execute(f'UPDATE {club} SET status = ? WHERE identify = ?', (0, identify))
            base.commit()
            bot.send_message(message.chat.id, "Успешно", reply_markup=types.ReplyKeyboardRemove())
        elif message.text == 'По заявке':
            cur.execute(f'UPDATE {club} SET status = ? WHERE identify = ?', (2, identify))
            base.commit()
            bot.send_message(message.chat.id, "Успешно", reply_markup=types.ReplyKeyboardRemove())
        else:
            bot.send_message(message.chat.id, "Неуспешно", reply_markup=types.ReplyKeyboardRemove())

    else:
        base = sqlite3.connect('tournaments_list')
        cur = base.cursor()

        if message.text == 'Открытый':
            cur.execute('UPDATE tournaments SET status = ? WHERE identify = ?', (1, identify))
            base.commit()
            bot.send_message(message.chat.id, "Успешно", reply_markup=types.ReplyKeyboardRemove())
        elif message.text == 'Закрытый':
            cur.execute('UPDATE tournaments SET status = ? WHERE identify = ?', (0, identify))
            base.commit()
            bot.send_message(message.chat.id, "Успешно", reply_markup=types.ReplyKeyboardRemove())
        elif message.text == 'По заявке':
            cur.execute(f'UPDATE tournaments SET status = ? WHERE identify = ?', (2, identify))
            base.commit()
            bot.send_message(message.chat.id, "Успешно", reply_markup=types.ReplyKeyboardRemove())
        else:
            bot.send_message(message.chat.id, "Неуспешно", reply_markup=types.ReplyKeyboardRemove())

    cur.close()
    base.close()


def edit12(message, identify, club=None):
    bot.send_message(message.chat.id, "Введите новую стоимость турнира(только целое число). Введите 0, если турнир бесплатный", reply_markup=types.ReplyKeyboardRemove())
    bot.register_next_step_handler(message, edit12_1, identify, club)


def edit12_1(message, identify, club=None):
    if club:
        base = sqlite3.connect('clubs')
        cur = base.cursor()

        cur.execute(f'UPDATE {club} SET cost = ? WHERE identify = ?', (message.text, identify))
        base.commit()
    else:
        base = sqlite3.connect('tournaments_list')
        cur = base.cursor()

        cur.execute('UPDATE tournaments SET cost = ? WHERE identify = ?', (message.text, identify))
        base.commit()

    bot.send_message(message.chat.id, "Успешно")
    cur.close()
    base.close()


def edit13(message, identify, club=None):
    mero_members(message, identify, 0, club=club)
    bot.send_message(message.chat.id, "^^^ Участники ^^^", reply_markup=types.ReplyKeyboardRemove())

    userslist(message, 0)
    markup = types.ReplyKeyboardMarkup()
    markup.add(types.KeyboardButton('Другой участник'))
    markup.add(types.KeyboardButton('Отмена'))
    bot.send_message(message.chat.id, "Введите номер участника, если он есть в списке ^^^ или выберите кнопку", reply_markup=markup)
    bot.register_next_step_handler(message, edit13_1, identify, club)


def edit13_1(message, identify, club=None):
    if message.text.strip() == 'Отмена':
        bot.send_message(message.chat.id, "Отменено", reply_markup=types.ReplyKeyboardRemove())
        return
    try:
        int(message.text.strip())
    except:
        if message.text.strip() == 'Другой участник':
            bot.send_message(message.chat.id, "Введите его ник", reply_markup=types.ReplyKeyboardRemove())
            bot.register_next_step_handler(message, edit13_2, identify, club)
        else:
            bot.send_message(message.chat.id, "Вы ввели не целое число!", reply_markup=types.ReplyKeyboardRemove())
            return
    else:
        base_us = sqlite3.connect('users')
        cur_us = base_us.cursor()
        cur_us.execute('SELECT * FROM users WHERE num = ?', (int(message.text.strip()),))
        users = cur_us.fetchall()
        cur_us.close()
        base_us.close()
        nick = ''
        club_user = ''
        us_id = ''
        for i in users:
            us_id = i[1]
            nick = i[2]
            club_user = i[3]
            break

        if club:
            base_memb = sqlite3.connect('mero')
            cur_memb = base_memb.cursor()
            cur_memb.execute(
                f'CREATE TABLE IF NOT EXISTS {club + identify} (num INTEGER PRIMARY KEY, id TEXT NOT NULL, nick TEXT NOT NULL, club TEXT NOT NULL, paid INTEGER, confirm INTEGER, request INTEGER)')
            base_memb.commit()
            cur_memb.execute(
                f'INSERT INTO {club + identify} (id, nick, club) VALUES ("{us_id}", "{nick}", "{club_user}")')
            base_memb.commit()
        else:
            base_memb = sqlite3.connect('tournament')
            cur_memb = base_memb.cursor()
            cur_memb.execute(
                f'CREATE TABLE IF NOT EXISTS {identify} (num INTEGER PRIMARY KEY, id TEXT NOT NULL, nick TEXT NOT NULL, club TEXT NOT NULL, paid INTEGER, confirm INTEGER, request INTEGER)')
            base_memb.commit()
            cur_memb.execute(
                f'INSERT INTO {identify} (id, nick, club) VALUES ("{us_id}", "{nick}", "{club_user}")')
            base_memb.commit()
        bot.send_message(message.chat.id, "Успешно")
        cur_memb.close()
        base_memb.close()

        edit13(message, identify, club)



def edit13_2(message, identify, club=None): # В message.text содержится ник
    bot.send_message(message.chat.id, "Введите клуб участника")
    bot.register_next_step_handler(message, edit13_3, identify, message.text, club=club)


def edit13_3(message, identify, nick, club=None):
    if club:
        base_memb = sqlite3.connect('mero')
        cur_memb = base_memb.cursor()
        cur_memb.execute(
            f'INSERT INTO {club + identify} (id, nick, club) VALUES ("{0}", "{nick}", "{message.text}")')
        base_memb.commit()
    else:
        base_memb = sqlite3.connect('tournament')
        cur_memb = base_memb.cursor()
        cur_memb.execute(
            f'INSERT INTO {identify} (id, nick, club) VALUES ("0", "{nick}", "{message.text}")')
        base_memb.commit()
    bot.send_message(message.chat.id, "Успешно")
    cur_memb.close()
    base_memb.close()

    edit13(message, identify, club)


def edit14(message, identify, club=None):
    mero_members(message, identify, 0, club=club)
    bot.send_message(message.chat.id, "^^^ Участники ^^^", reply_markup=types.ReplyKeyboardRemove())

    markup = types.ReplyKeyboardMarkup()
    markup.add(types.KeyboardButton('Отмена'))
    bot.send_message(message.chat.id, "Введите номер участника (только целое число)", reply_markup=markup)
    bot.register_next_step_handler(message, edit14_1, identify, club)


def edit14_1(message, identify, club=None):
    if message.text.strip() == 'Отмена':
        bot.send_message(message.chat.id, "Отменено", reply_markup=types.ReplyKeyboardRemove())
        return
    try:
        int(message.text.strip())
    except:
        bot.send_message(message.chat.id, "Вы ввели не целое число!")
        edit14(message, identify, club)
        return
    if club:
        base_memb = sqlite3.connect('mero')
        cur_memb = base_memb.cursor()
        cur_memb.execute(f'DELETE FROM {club + identify} WHERE num = ?', (int(message.text.strip()),))
        base_memb.commit()
    else:
        base_memb = sqlite3.connect('tournament')
        cur_memb = base_memb.cursor()
        cur_memb.execute(f'DELETE FROM {identify} WHERE num = ?', (int(message.text.strip()),))
        base_memb.commit()
    bot.send_message(message.chat.id, "Успешно")
    cur_memb.close()
    base_memb.close()

    edit14(message, identify, club)


def tournament_delete(message, identify):
    base_list = sqlite3.connect('tournaments_list')
    cur_list = base_list.cursor()

    base_tour = sqlite3.connect('tournament')
    cur_tour = base_tour.cursor()

    try:
        cur_list.execute('DELETE FROM tournaments WHERE identify = ?', (identify,))
        base_list.commit()
        bot.send_message(message.chat.id, "Успешно")
    except Exception as e:
        bot.send_message(message.chat.id, "Ошибка, скорее всего, неверный идентификатор")
        print(e)
    try:
        cur_tour.execute(f'DROP TABLE {identify}')
        base_tour.commit()
    except Exception as e:
        print(e)

    cur_list.close()
    base_list.close()
    cur_tour.close()
    base_tour.close()


def mero_delete(message, identify, club):
    base_list = sqlite3.connect('clubs')
    cur_list = base_list.cursor()

    base_mero = sqlite3.connect('mero')
    cur_mero = base_mero.cursor()

    try:
        cur_list.execute(f'DELETE FROM {club} WHERE identify = ?', (identify,))
        base_list.commit()
        bot.send_message(message.chat.id, "Успешно")
    except Exception as e:
        bot.send_message(message.chat.id, "Ошибка, скорее всего, неверный идентификатор")
        print(e)
    try:
        cur_mero.execute(f'DROP TABLE {club+identify}')
        base_mero.commit()
    except Exception as e:
        print(e)

    cur_list.close()
    base_list.close()

    cur_mero.close()
    base_mero.close()


def spam1(message):
    markup = types.ReplyKeyboardMarkup()
    markup.add(types.KeyboardButton('Отмена'))
    bot.send_message(message.chat.id, "Введите сообщение, которое хотите разослать всем юзерам бота", reply_markup=markup)
    bot.register_next_step_handler(message, spam2)


def spam2(message):
    if message.text == 'Отмена':
        bot.send_message(message.chat.id, "Отменено",
                         reply_markup=types.ReplyKeyboardRemove())
        admin(message)
        return
    else:
        base = sqlite3.connect('users')
        cur = base.cursor()

        cur.execute('SELECT * FROM users')
        users = cur.fetchall()

        cur.close()
        base.close()

        for i in users:
            bot.send_message(i[1], message.text)


def send1(message, identify, club=None):
    markup = types.ReplyKeyboardMarkup()
    markup.add(types.KeyboardButton('Отмена'))
    markup.add(types.KeyboardButton('Оплата взноса'))
    markup.add(types.KeyboardButton('Подтверждение участия'))
    bot.send_message(message.chat.id,"Введите сообщение, которое хотите разослать всем участникам или выберите кнопку ниже", reply_markup=markup)
    bot.register_next_step_handler(message, send2, identify, club)


def send2(message, identify, club=None):
    if message.text == 'Отмена':
        bot.send_message(message.chat.id, "Отменено",
                         reply_markup=types.ReplyKeyboardRemove())
        admin(message)
        return

    if message.text == 'Оплата взноса':
        name, typ = '', ''
        cost = 0
        if club:
            base = sqlite3.connect('mero')
            cur = base.cursor()
            base_info = sqlite3.connect('clubs')
            cur_info = base_info.cursor()

            cur_info.execute(f'SELECT * FROM {club} WHERE identify = ?', (identify,))
            data = cur_info.fetchall()
            for i in data:
                name = i[2]
                cost = int(i[7])
                break

            cur.execute(f'SELECT * FROM {club + identify}')
            players = cur.fetchall()
            payload = club + identify
        else:
            base = sqlite3.connect('tournament')
            cur = base.cursor()
            base_info = sqlite3.connect('tournaments_list')
            cur_info = base_info.cursor()

            cur_info.execute('SELECT * FROM tournaments WHERE identify = ?', (identify,))
            data = cur_info.fetchall()
            for i in data:
                name = i[2]
                typ = i[7]
                cost = int(i[10])
                break

            cur.execute(f'SELECT * FROM {identify}')
            players = cur.fetchall()
            payload = identify

        cur.close()
        base.close()
        cur_info.close()
        base_info.close()

        if cost < 1:
            bot.send_message(message.chat.id, "Участие бесплатное!")
            return

        if players:
            if typ == 'team':
                for i in players:
                    if i[6] == 0:
                        bot.send_invoice(i[1], 'Оплатить участие', f'Вы - участник {name.lower()}. Пожалуйста, оплатите взнос за участие', payload, settings['PAY_TOKEN'], 'RUB', [types.LabeledPrice("Оплатить", cost*100)])
            else:
                for i in players:
                    if i[6] == 0:
                        bot.send_invoice(i[1], 'Оплатить участие', f'Вы - создатель команды в турнире {name.lower()}. Пожалуйста, оплатите взнос за участие вашей команды', payload, settings['PAY_TOKEN'], 'RUB', [types.LabeledPrice("Оплатить", cost*100)])
        bot.send_message(message.chat.id, 'Успешно', reply_markup=types.ReplyKeyboardRemove())
        return

    if message.text == 'Подтверждение участия':
        markup = types.InlineKeyboardMarkup()
        if club:
            base = sqlite3.connect('mero')
            cur = base.cursor()
            base_info = sqlite3.connect('clubs')
            cur_info = base_info.cursor()

            cur_info.execute(f'SELECT * FROM {club} WHERE identify = ?', (identify,))
            data = cur_info.fetchall()
            for i in data:
                name = i[2]
                break

            cur.execute(f'SELECT * FROM {club + identify}')
            players = cur.fetchall()
            markup.add(types.InlineKeyboardButton('Подтвердить участие', callback_data=club+identify+'confirm'))
        else:
            base = sqlite3.connect('tournament')
            cur = base.cursor()
            base_info = sqlite3.connect('tournaments_list')
            cur_info = base_info.cursor()

            cur_info.execute('SELECT * FROM tournaments WHERE identify = ?', (identify,))
            data = cur_info.fetchall()
            for i in data:
                name = i[2]
                break

            cur.execute(f'SELECT * FROM {identify}')
            players = cur.fetchall()
            markup.add(types.InlineKeyboardButton('Подтвердить участие', callback_data=identify+'confirm'))

        cur.close()
        base.close()
        cur_info.close()
        base_info.close()

        for i in players:
            if i[6] == 0:
                bot.send_message(i[1], f'Вы - участник {name.lower()}. Подтвердите свое участие', reply_markup=markup)
        return

    if club:
        base = sqlite3.connect('mero')
        cur = base.cursor()
        cur.execute(f'SELECT * FROM {club + identify}')
    else:
        base = sqlite3.connect('tournament')
        cur = base.cursor()
        cur.execute(f'SELECT * FROM {identify}')
    players = cur.fetchall()
    cur.close()
    base.close()
    for i in players:
        if i[1] != '0' and i[6] == 1:
            bot.send_message(i[1], message.text)
    bot.send_message(message.chat.id, 'Успешно', reply_markup=types.ReplyKeyboardRemove())


'''@bot.message_handler(commands=['add'])
def creating_tables(message):
    base = sqlite3.connect('clubs')
    cur = base.cursor()
    clubs = ['DarkTurn', 'LETI', 'Polytech', 'Mining', 'EveningParty', 'TechnoMafia', 'BONCHMAFIA']
    for club in clubs:
        cur.execute(f'ALTER TABLE {club} ADD COLUMN admin TEXT NOT NULL DEFAULT {None}')
        base.commit()
    cur.close()
    base.close()

    #base = sqlite3.connect('users')
    #cur = base.cursor()
    #cur.execute('CREATE TABLE IF NOT EXISTS users (num INTEGER PRIMARY KEY, id TEXT NOT NULL, nick TEXT NOT NULL, club TEXT NOT NULL)')
    #base.commit()
    #cur.close()
    #base.close()

    base = sqlite3.connect('clubs')
    cur = base.cursor()
    clubs = ['DarkTurn', 'LETI', 'Polytech', 'Mining', 'EveningParty', 'TechnoMafia', 'BONCHMAFIA']
    for club in clubs:
        cur.execute(f'CREATE TABLE IF NOT EXISTS {club} (num INTEGER PRIMARY KEY, identify TEXT NOT NULL, name TEXT NOT NULL, desc TEXT NOT NULL, date TEXT NOT NULL, limits INTEGER, status INTEGER, cost INTEGER)')
        base.commit()
    cur.close()
    base.close()

    base = sqlite3.connect('tournaments_list')
    cur = base.cursor()
    cur.execute('CREATE TABLE IF NOT EXISTS tournaments (num INTEGER PRIMARY KEY, identify TEXT NOT NULL, name TEXT NOT NULL, desc TEXT NOT NULL, date TEXT NOT NULL, rules TEXT NOT NULL, score TEXT NOT NULL, type TEXT NOT NULL, limits INTEGER, status INTEGER, cost INTEGER)')
    base.commit()
    cur.close()
    base.close()

    bot.send_message(message.chat.id, 'У')'''


def donut1(message):
    bot.send_message(message.chat.id, "Спасибо, что решили поддержать нас!!\nПожалуйста, введите сумму, на которую хотите нас поддержать (60р и больше)")
    bot.register_next_step_handler(message, donut2)

def donut2(message):
    try:
        int(message.text.strip())
    except:
        bot.send_message(message.chat.id, "Введите целое число")
        return
    if int(message.text.strip()) < 60:
        bot.send_message(message.chat.id, "Минимальная сумма 60р!")
        return
    bot.send_invoice(message.chat.id, 'Донат', 'Поддержите организаторов студлиги!', 'donut', settings['PAY_TOKEN'], 'RUB', [types.LabeledPrice("❤", int(message.text)*100)])


@bot.message_handler()
def meow(message):
    if message.text.lower() == 'мяу':
        bot.reply_to(message, "мяу")
        print(f"Мяу от {message.from_user.first_name} {message.from_user.last_name}")


bot.polling(none_stop=True)
